<html>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <head>
        <style>
            #video {
                position: absolute;
                top: 0;
                left: 0;
                margin: 0;
                padding: 0;
                z-index: -1;
                filter: blur(10px);
                filter: saturate(10);
            }
            #sensibility, #log {
                color: black;
                font-family: arial;
            }
            #log {
                display: none;
            }
            #overlay {
                position: absolute;
                top: 0;
                left: 0;
                margin: 0;
                padding: 0;
                width: 100vw;
                height: 50%;
                background-color: white;
            }
            .slick-current {
                font-size: 40pt;                
            }
            #slider * {
                height: 50pt;
                line-height: 50pt;
                font-family: arial;
                text-align: center;
            }
        </style>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.3/moment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.3/locale/pt-br.js"></script>
        
        <script src="https://cdn.bootcss.com/tracking.js/1.1.3/tracking-min.js"></script>
        <script src="https://cdn.bootcss.com/tracking.js/1.1.3/data/eye-min.js"></script>
        <script src="https://cdn.bootcss.com/tracking.js/1.1.3/data/face-min.js"></script>
        <script src="https://cdn.bootcss.com/tracking.js/1.1.3/data/mouth-min.js"></script>
        
        <script>
        $(() => {

            let video = $('#video')[0];

            if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({
                    video: {
                        mandatory: {
                            minWidth: 640,
                            minHeight: 480
                        }
                    }
                }).then(function(stream) {
                    $.ajax({url: '/poc-captura-video/pt_BR_wordlist.txt'})
                    .done((wordlist) => {
                        video.src = window.URL.createObjectURL(stream);
                        video.play();
                        
                        let characters = ['A', 'Á', 'Â', 'Ã', 'O', 'Ó', 'Ô', 'Õ', 'I', 'Í', 'R', 'E', 'É', 'Ê', 'C', 'Ç', 'N', 'T', 'L', 'S', 'D', 'M', 'U', 'Ú', 'B', 'G', 'P', 'F', 'H', 'V', 'Z', 'X', 'Q', 'J', 'K', 'Y', 'W'];

                        let totalCharacters = characters.length;

                        for (let i = 0; i < characters.length; i++) {
                            let conteinerCharacter = $('<div>');
                            conteinerCharacter.text(characters[i]);
                            $('#slider').append(conteinerCharacter);
                        }

                        $("#slider").slick({
                            infinite: true,
                            arrows: false,
                            autoplaySpeed: 500,
                            centerMode: true,                
                            slidesToShow: 5,
                            mobileFirst: true
                        });
                        $('#slider').slick('slickPlay');

                        var colors = new tracking.ColorTracker(['yellow']);

                        let yellowTop = -1;

                        let yellow = $('<div>');
                        yellow.css({
                            borderColor: 'yellow',                
                            borderStyle: 'solid',
                            position: 'absolute',
                            borderWidth: 0
                        });
                        $(document.body).append(yellow);

                        colors.on('track', function(event) {
                            if (event.data.length === 0) {
                                // No colors were detected in this frame.
                            } else {
                                let sensibility = $('#sensibility').val();

                                event.data.forEach(function(rect) {

                                    yellow.css({
                                        top: rect.y,
                                        left: rect.x,
                                        width: rect.width,
                                        height: rect.height,
                                        borderWidth: 2                              
                                    });

                                    if (yellowTop != -1) {
                                        if (yellowTop - rect.y > sensibility) {
                                            $('#slider').slick('slickPause');
                                            
                                            let character = characters[$('#slider').slick('slickCurrentSlide')];
                                            let text = $('#text').text() + character;
                                            $('#text').text(text);
                                            let regex = new RegExp('\n' + text + '.*', 'g');
                                            let words = wordlist.match(regex);                                           
                                            let nextCharacters = new Set();

                                            for (let i = 0; i < totalCharacters; i++) {
                                                $('#slider').slick('slickRemove', i);
                                            }

                                            for (let i = 0; i < words.length; i++) {                                                
                                                let nextCharacter = words[i].charAt(text.length + 1);
                                                if (nextCharacter) {
                                                    nextCharacters.add(nextCharacter.toUpperCase());
                                                }                                             
                                            }
                                            
                                            totalCharacters = nextCharacters.size;

                                            nextCharacters.forEach((character) => {
                                                let conteinerCharacter = $('<div>');
                                                conteinerCharacter.text(character);
                                                $('#slider').slick('slickAdd', conteinerCharacter);
                                            });

                                            $('#slider').slick('slickPlay');
                                        }
                                    }
                                    yellowTop = rect.y;

                                });
                            }
                        });

                        tracking.track('#video', colors);
                    });                    
                });
            }           
        });           
        </script>
    </head>
    <body>        
        <video id="video" preload autoplay loop muted></video>
        <div id="overlay">
            <input id="sensibility" type="range" min="1" max="10" value="5">
            <div id="slider"></div>
            <div id="text"></div>
            <div id="log">OK</div>
        </div>
    </body>
</html>