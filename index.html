<html>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <head>
        <style>
            #video {
                position: absolute;
                top: 0;
                left: 0;
                margin: 0;
                padding: 0;
                z-index: -1;
                filter: blur(10px);
                filter: saturate(10);
            }
            #sensibility {
                color: black;
                font-family: arial;
                margin: 10px 0 10px 0;
            }
            #overlay {
                position: absolute;
                top: 0;
                left: 0;
                margin: 0;
                padding: 0;
                background-color: white;
                width: 100vw;
                height: 100vh;
            }
            #slider {
                list-style-type: none;
                margin: 0;
                padding: 0;
                height: 50pt;
                overflow: hidden;
            }
            #slider * {
                height: 50pt;
                line-height: 50pt;
                font-family: arial;
                text-align: center;
                display: inline-block;
                width: 50pt;
                box-sizing: border-box;
                vertical-align: middle;
                font-size: 16pt;
                border-top-style: solid;
                border-bottom-style: solid;
                border-color: lightgray;
                border-top-width: 1px;
                border-bottom-width: 1px;
            }
            #slider *:nth-child(2) {
                border-style: none;
                background-color: orange;
                font-size: 40pt;
            }
            #text {
                margin: 10px 0 0 0;
                resize: none;
                display: inline-block;
                white-space: pre;
                font-size: 14pt;
                height: 14pt;
                font-family: arial;
            }
            .cursor-active {
                border-width: 2px;
                border-right-style: solid;
            }
        </style>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.3/moment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.3/locale/pt-br.js"></script>
        
        <script src="https://cdn.bootcss.com/tracking.js/1.1.3/tracking-min.js"></script>
        <script src="https://cdn.bootcss.com/tracking.js/1.1.3/data/eye-min.js"></script>
        <script src="https://cdn.bootcss.com/tracking.js/1.1.3/data/face-min.js"></script>
        <script src="https://cdn.bootcss.com/tracking.js/1.1.3/data/mouth-min.js"></script>
        
        <script>
        $(() => {
            setInterval(() => {
                $('#text').toggleClass('cursor-active');
            }, 500);            

            function nextCharacters(text, wordlist) {
                let regex = new RegExp('\n' + text + '.*', 'gi');
                let words = wordlist.match(regex);
                if (words == null) {
                    words = [];
                }
                let characters = new Set();                                                                     

                for (let i = 0; i < words.length; i++) {                                                
                    let character = words[i].charAt(text.length + 1);
                    if (character) {
                        characters.add(character.toUpperCase());
                    }                                             
                }
  
                return ['.'].concat(['→', '←']).concat([...characters]);
            }

            let video = $('#video')[0];

            if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({
                    video: {
                        mandatory: {
                            minWidth: 640,
                            minHeight: 480
                        }
                    }
                }).then(function(stream) {
                    $.ajax({url: '/poc-captura-video/pt_BR_wordlist.txt'})
                    .done((wordlist) => {
                        video.addEventListener('loadeddata', (event) => {
                            $('#overlay').width(video.videoWidth);
                            $('#overlay').height(video.videoHeight);
                        }, false);

                        video.src = window.URL.createObjectURL(stream);
                        video.play();

                        let characters = nextCharacters('', wordlist);

                        for (let i = 0; i < characters.length; i++) {
                            let conteinerCharacter = $('<li>');
                            conteinerCharacter.text(characters[i]);
                            $('#slider').append(conteinerCharacter);
                        }

                        let stopSpin = false;

                        let callbackStopSpin = () => {};

                        function spin() {
                            let firstChild = $('#slider li:first-child');
                            if (!stopSpin) {       
                                firstChild.fadeOut(2000, () => {                                
                                    firstChild.remove();
                                    $('#slider').append(firstChild);
                                    firstChild.show();                               
                                    spin();                                               
                                }); 
                            } else {
                                callbackStopSpin(firstChild);
                            }                                    
                        }
                           
                        spin();

                        var colors = new tracking.ColorTracker(['yellow']);

                        let yellowTop = -1;

                        let yellow = $('<div>');
                        yellow.css({
                            borderColor: 'yellow',                
                            borderStyle: 'solid',
                            position: 'absolute',
                            borderWidth: 0
                        });
                        $(document.body).append(yellow);

                        colors.on('track', function(event) {
                            if (event.data.length === 0) {
                                // No colors were detected in this frame.
                            } else {
                                let sensibility = $('#sensibility').val();

                                event.data.forEach(function(rect) {

                                    yellow.css({
                                        top: rect.y,
                                        left: rect.x,
                                        width: rect.width,
                                        height: rect.height,
                                        borderWidth: 2                              
                                    });

                                    if (yellowTop != -1) {
                                        if (yellowTop - rect.y > sensibility) {                                          
                                            callbackStopSpin = (firstChild) => {                                                                                   
                                                let character = firstChild.text();
                                                let text = '';
                                                
                                                if (character == '→') {
                                                    text = $('#text').text() + ' ';
                                                } else if (character == '←') {
                                                    text = $('#text').text().slice(0, -1);
                                                } else if (character == '.') {
                                                    let message = new SpeechSynthesisUtterance($('#text').text());
                                                    message.lang = 'pt-BR';
                                                    window.speechSynthesis.speak(message);
                                                    text = '';                                                    
                                                } else {                                                    
                                                    text = $('#text').text() + character;
                                                }

                                                $('#text').text(text);

                                                let nextTextParts = text.split(' ');
                                                let nextText = nextTextParts[nextTextParts.length - 1];
                                                characters = nextCharacters(nextText, wordlist);

                                                // "fala", "apagar", "espaço" e um caractere qualquer
                                                while (characters.length == 4) {                                                                                                         
                                                    let text = $('#text').text() + characters[0];
                                                    $('#text').text(text);
                                                    let nextTextParts = text.split(' ');
                                                    let nextText = nextTextParts[nextTextParts.length - 1];
                                                    characters = nextCharacters(nextText, wordlist);
                                                }
                                            
                                                // "fala", "apagar" e "espaço"
                                                if (characters.length == 3) {
                                                    let text = $('#text').text() + ' ';
                                                    $('#text').text(text);
                                                    characters = nextCharacters('', wordlist);
                                                }

                                                $('#slider').fadeOut(250, () => {
                                                    $('#slider').empty();
                                                    for (let i = 0; i < characters.length; i++) {                                               
                                                        let conteinerCharacter = $('<li>');
                                                        conteinerCharacter.text(characters[i]);
                                                        $('#slider').append(conteinerCharacter);
                                                    }
                                                    $('#slider').fadeIn(250, () => {
                                                        stopSpin = false;
                                                        spin();
                                                    });                                                    
                                                });
                                            };
                                            stopSpin = true;
                                        }
                                    }
                                    yellowTop = rect.y;
                                });

                            }
                        });

                        tracking.track('#video', colors);
                    });                    
                });
            }           
        });           
        </script>
    </head>
    <body>        
        <video id="video" preload autoplay loop muted></video>
        <div id="overlay">
            <label>
                Sensibilidade
                <input id="sensibility" type="range" min="1" max="10" value="5">
            </label>
            <label>
                Velocidade
                <input id="speed" type="range" min="1" max="10" value="5">
            </label>
            <ul id="slider"></ul>
            <div id="text"></div>
        </div>
    </body>
</html>