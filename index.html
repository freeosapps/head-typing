<html>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <head>
        <style>
            #video {
                position: absolute;
                top: 0;
                left: 0;
                margin: 0;
                padding: 0;
                z-index: -1;
                filter: blur(10px);
                filter: saturate(10);
                width: 100vw;
                height: 100vh;
            }
            label {
                display: inline-block;
                font-family: arial;
                font-size: 14pt;
                margin: 10px;
                white-space: nowrap;
                color: gray;                
            }
            label * {
                vertical-align: middle;
            }
            label span {
                border-width: 1px;
                border-style: dotted;
                padding: 5px;
                background-color: lightyellow;
            }
            label progress, label input {
                height: 25pt;
            }
            #overlay {
                position: absolute;
                top: 0;
                left: 0;
                margin: 0;
                padding: 0;
                background-color: lemonchiffon;
                width: 100vw;
                height: 100vh;
            }
            #slider {
                list-style-type: none;
                margin: 0;
                padding: 0;
                height: 50pt;
                overflow: hidden;
                box-shadow: 0px 0px 5px lightslategray;
                background-color: white;
            }
            #slider * {
                height: 50pt;
                line-height: 50pt;
                font-family: arial;
                text-align: center;
                display: inline-block;
                width: 50pt;
                box-sizing: border-box;
                vertical-align: middle;
                font-size: 16pt;
                border-top-style: solid;
                border-bottom-style: solid;
                border-color: lightgray;
                border-top-width: 1px;
                border-bottom-width: 1px;
                background-color: white;
            }
            #slider *:nth-child(2) {
                border-style: none;
                background-color: orange;
                font-size: 40pt;
            }
            #text {
                margin: 10px 0 0 0;
                resize: none;
                display: inline-block;
                white-space: pre;
                font-size: 14pt;
                height: 14pt;
                font-family: arial;
                background-color: white;
                box-shadow: 0px 0px 5px lightslategray;
                padding-top: 10px;
                padding-bottom: 10px;
            }
            .cursor-active {
                border-width: 2px;
                border-right-style: solid;
            }
        </style>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.3/moment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.3/locale/pt-br.js"></script>
        
        <script src="https://cdn.bootcss.com/tracking.js/1.1.3/tracking-min.js"></script>
        <script src="https://cdn.bootcss.com/tracking.js/1.1.3/data/eye-min.js"></script>
        <script src="https://cdn.bootcss.com/tracking.js/1.1.3/data/face-min.js"></script>
        <script src="https://cdn.bootcss.com/tracking.js/1.1.3/data/mouth-min.js"></script>
        
        <script>
        $(() => {
            function mesureText(text, fontFamily, fontSize) {
                var c = document.createElement("canvas");
                var ctx = c.getContext("2d");
                ctx.font = fontSize + ' ' + fontFamily;
                return ctx.measureText(text).width;
            }

            setInterval(() => {
                $('#text').toggleClass('cursor-active');
            }, 500);            

            function nextCharacters(text, wordlist) {
                let regex = new RegExp('\n' + text + '.*', 'gi');
                let words = wordlist.match(regex);
                if (words == null) {
                    words = [];
                }
                let characters = new Set();                                                                     

                for (let i = 0; i < words.length; i++) {                                                
                    let character = words[i].charAt(text.length + 1);
                    if (character) {
                        characters.add(character.toUpperCase());
                    }                                             
                }
  
                return ['.', '→', '←'].concat([...characters]);
            }

            function updateNextCharacters(characters) {
                for (let i = 0; i < characters.length; i++) {
                    let conteinerCharacter = $('<li>');
                    conteinerCharacter.text(characters[i]);
                    $('#slider').append(conteinerCharacter);
                }
            }

            let video = $('#video')[0];

            if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({
                    video: {
                        mandatory: {
                            minWidth: 640,
                            minHeight: 480
                        }
                    }
                }).then(function(stream) {
                    $.ajax({url: '/poc-captura-video/pt_BR_wordlist.txt'})
                    .done((wordlist) => {
                        video.src = window.URL.createObjectURL(stream);
                        video.play();

                        let characters = nextCharacters('', wordlist);
                        updateNextCharacters(characters);

                        let stopSpin = false;

                        let callbackStopSpin = () => {};

                        function spin() {
                            let firstChild = $('#slider li:first-child');
                            if (!stopSpin) {
                                let speed = 6 - $('#speed').val();
                                firstChild.fadeOut(speed * 1000, () => {                                
                                    firstChild.remove();
                                    $('#slider').append(firstChild);
                                    firstChild.show();                               
                                    spin();                                               
                                }); 
                            } else {
                                callbackStopSpin(firstChild);
                            }                                    
                        }
                           
                        spin();

                        var colors = new tracking.ColorTracker(['yellow']);

                        let markerTop = -1;

                        let backspaceNotSelectedBefore = true;

                        colors.on('track', function(event) {
                            if (event.data.length === 0) {
                                // No colors were detected in this frame.
                            } else {
                                let sensibility = 11 - $('#sensibility').val();

                                event.data.forEach(function(rect) {
                                    if (markerTop != -1) {                                        
                                        let movement = markerTop - rect.y;
                                        $('#movement').prop('max', sensibility);
                                        $('#movement').val(movement);
                                        setTimeout(() => {
                                            $('#movement').val('0');
                                        }, 1000);
                                        if (movement > sensibility) {
                                            callbackStopSpin = (firstChild) => {                                                                                   
                                                let character = firstChild.text();
                                                let text = '';
                                                
                                                if (character == '→') {
                                                    text = $('#text').text() + ' ';
                                                    backspaceNotSelectedBefore = true;
                                                } else if (character == '←') {
                                                    text = $('#text').text().slice(0, -1);
                                                    backspaceNotSelectedBefore = false;
                                                } else if (character == '.') {
                                                    let message = new SpeechSynthesisUtterance($('#text').text());
                                                    message.lang = 'pt-BR';
                                                    window.speechSynthesis.speak(message);
                                                    text = '';
                                                    backspaceNotSelectedBefore = true;
                                                } else {                                                    
                                                    text = $('#text').text() + character;
                                                    backspaceNotSelectedBefore = true;
                                                }

                                                alert('$(window).width() =' + $(window).width());
                                                alert('text width =' + mesureText(text, $('#text').css('fontFamily'), $('#text').css('fontSize')));

                                                if (mesureText(text, $('#text').css('fontFamily'), $('#text').css('fontSize')) > $(window).width()) {
                                                    $('#text').text('<br>');
                                                }

                                                $('#text').text(text);

                                                let nextTextParts = text.split(' ');
                                                let nextText = nextTextParts[nextTextParts.length - 1];
                                                characters = nextCharacters(nextText, wordlist);

                                                // "fala", "apagar", "espaço" e um caractere qualquer
                                                while (characters.length == 4 && backspaceNotSelectedBefore) {                                                                                                         
                                                    let text = $('#text').text() + characters[characters.length - 1];
                                                    $('#text').text(text);
                                                    let nextTextParts = text.split(' ');
                                                    let nextText = nextTextParts[nextTextParts.length - 1];
                                                    characters = nextCharacters(nextText, wordlist);
                                                }                                                                                                                                                                                   

                                                $('#slider').hide(0, () => {
                                                    $('#slider').empty();
                                                    updateNextCharacters(characters);
                                                    $('#slider').show(0, () => {
                                                        stopSpin = false;
                                                        spin();
                                                    });                                                    
                                                });                                               
                                            };

                                            stopSpin = true;
                                        }
                                    }

                                    markerTop = rect.y;
                                });

                            }
                        });

                        tracking.track('#video', colors);
                    });                    
                });
            }           
        });           
        </script>
    </head>
    <body>        
        <video id="video" preload autoplay loop muted></video>
        <div id="overlay">
            <label>
                <span>Sensibilidade:</span>
                <input id="sensibility" type="range" min="1" max="10" value="9">
            </label>
            <label>
                <span>Velocidade:</span>
                <input id="speed" type="range" min="1" max="5" value="5">
            </label>
            <label>
                <span>Movimento:</span>
                <progress id="movement" max="10" value="0"></progress>
            </label>
            <ul id="slider"></ul>
            <div id="text"></div>
        </div>
    </body>
</html>