<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <!--<link rel="stylesheet" href="index.css">
        <script src="interlocutor.js"></script>
        <script src="placa.js"></script>
        <script src="relogio.js"></script>
        <script src="anotacao.js"></script>
        <script src="index.js"></script>-->
        <style>
            .tela {
                font-family: sans-serif;
                margin: 0;
                padding: 0;
            }
            .quadro {
                width: 100%;
                border-collapse: collapse;
                text-align: center;
                color: dimgray;
                -webkit-user-select: none; /* Safari 3.1+ */
                -moz-user-select: none; /* Firefox 2+ */
                -ms-user-select: none; /* IE 10+ */
                user-select: none; /* Standard syntax */
                margin: 0;
            }
            .quadro_oculto {
                display: none;
            }
            .celula {
                border-width: 1px;
                border-color: white;
                border-style: solid;
                background-color: #f7f7ea; 
                height: 8vh; /* seria 8.5vh, mas para evitar scroll foi usado 8vh */
                box-sizing: border-box;
                width: 20%;
            }
            .celula_pequena {
                width: 16.66%;
            }
            .celula_descrita {
                font-size: 7pt;
            }
            .ponteiro {
                position: absolute;
                background-color: rgba(255, 224, 166, .3); 
                border-width: 1px;
                border-style: dotted;
                border-color: orange;
                box-sizing: border-box;
            }
            .ponteiro_oculto {
                top: 0;
                left: 0;
                width: 0;
                height: 0;
                display: none;
            }
            .anotacao {
                height: 15vh;
                border-width: 1px 0;
                border-style: solid;
                border-color: lightgray;
                box-sizing: border-box;
                color: dimgray;
                padding: 5px;
                overflow: hidden;
            }
            .anotacao__texto {
                word-wrap: break-word;
                white-space: pre-wrap;
            }
            .anotacao__texto_cursor {
                border-right-width: 1px;
                border-right-style: solid;
                border-right-color: dimgray;
            }
            .tela__aplicativo {
                display: none;
                width: 100vw;
                height: 100vh;
            }
            .tela__inicio {
                width: 100vw;
                height: 100vh;
                color: dimgray;
                font-family: monospace;
                text-align: center;
                background-color: beige;
            }
            .tela__botao {
                border-radius: 100%;
                padding: 20px;
                background-color: lightslategray;
                color: white;
                font-size: 12pt;
            }
            .tela__botao_continuar {
                display: none;
            }
            .tela__conteudo-inicio {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%); 
                text-decoration: underline;
            }
        </style>
        <script>
        $(() => {
            $('.tela__botao_iniciar, .tela__botao_continuar').bind('click', () => {
                let documentElement = document.documentElement,
                requestFullscreen = documentElement.requestFullscreen
                    || documentElement.webkitRequestFullScreen
                    || documentElement.mozRequestFullScreen
                    || documentElement.msRequestFullscreen 
                ;
                requestFullscreen.call(documentElement);
            })
            $(document).bind('fullscreenchange webkitfullscreenchange mozfullscreenchange MSFullscreenChange', () => {
                let isFullScreen = document.isFullScreen || document.webkitIsFullScreen || document.mozFullScreen;
                if (!isFullScreen) {
                    pausar = true;
                    $('.tela__inicio').show();
                    $('.tela__aplicativo').hide();
                    $('.tela__botao_iniciar').hide();
                    $('.tela__botao_continuar').show();
                } else {
                    $('.tela__inicio').hide();
                    $('.tela__aplicativo').show();
                    $('.tela__wotao_iniciar').show();
                    $('.tela__botao_continuar').hide();
                    pausar = false;
                }
            });

            $.get('pt_BR_wordlist.txt').done((dicionario) => { 
                setInterval(() => {
                    $('.anotacao__texto').toggleClass('anotacao__texto_cursor');
                }, 500);
                let palavras = dicionario.split('\n');
                $(window).bind('resize', () => {
                    $('.ponteiro').addClass('ponteiro_oculto');
                });
                let temporizador = undefined;
                let percorrendoQuadros = false;
                let percorrendoLinhas = false;
                let elementoAtual = null;
                let permitirTrocaDeArea = true;
                let pausar = false;

                let percorrerAreas = (elementos) => {
                    let arrayElementos = elementos.toArray();
                    clearInterval(temporizador);
                    temporizador = setInterval(() => {
                        if (!pausar) {
                            elementoAtual = $(arrayElementos.shift());
                            $('.ponteiro').removeClass('ponteiro_oculto');
                            $('.ponteiro').animate({
                                top: elementoAtual.offset().top,
                                left: elementoAtual.offset().left,
                                width: elementoAtual.outerWidth(),
                                height: elementoAtual.outerHeight()
                            });
                            arrayElementos.push(elementoAtual[0]);
                            permitirTrocaDeArea = true;
                        }
                    }, 1500);
                };

                let maiusculas = false;
                let acentuadas = false; 

                let sugerirPalavras = () => {
                    $('.sugestoes').empty();
                    $('.ponteiro').addClass('ponteiro_oculto');
                    let partesUltimaPalavra = $('.anotacao__texto').text().match(/[^\s\.\,][^\s\.\,]*$/, '');
                    let ultimaPalavra = undefined;
                    if (partesUltimaPalavra) {
                        ultimaPalavra = partesUltimaPalavra[0];
                    } else {
                        ultimaPalavra = '';
                    }
                    let regex = new RegExp(`\\n${ultimaPalavra}.{2,}\\n`, 'g');
                    let palavrasEncontradas = dicionario.match(regex);
                    if (palavrasEncontradas) {
                        let sugestoesDePalavras = palavrasEncontradas.slice(0, Math.min(8, palavrasEncontradas.length));
                        let sugestoesDePalavrasLinha1 = sugestoesDePalavras.slice(0, 4);
                        let sugestoesDePalavrasLinha2 = sugestoesDePalavras.slice(4, 8);
                        let quadroSugestoes = $('<table>').addClass('quadro');
                        let primeiraLinhaQuadroSugestoes = $('<tr>').addClass('linha');
                        let segundaLinhaQuadroSugestoes = $('<tr>').addClass('linha');
                        if (sugestoesDePalavrasLinha1.length) {
                            quadroSugestoes.append(primeiraLinhaQuadroSugestoes);
                            if (sugestoesDePalavrasLinha2.length) {
                                quadroSugestoes.append(segundaLinhaQuadroSugestoes);
                            }
                        }
                        for (let i = 0; i < sugestoesDePalavrasLinha1.length; i++) {
                            let celula = $('<td>').addClass('celula');
                            let sufixo = sugestoesDePalavrasLinha1[i].replace(/\n/g, '');
                            sufixo = sufixo.slice(ultimaPalavra.length, sufixo.length);
                            celula.text(sufixo);
                            primeiraLinhaQuadroSugestoes.append(celula);
                        }
                        if (sugestoesDePalavrasLinha1.length) {
                            let celula = $('<td>').addClass('celula').addClass('celula_descrita').text('Continuar');
                            primeiraLinhaQuadroSugestoes.append(celula);
                        }
                        for (let i = 0; i < sugestoesDePalavrasLinha2.length; i++) {
                            let celula = $('<td>').addClass('celula');
                            let sufixo = sugestoesDePalavrasLinha2[i].replace(/\n/g, '');
                            sufixo = sufixo.slice(ultimaPalavra.length, sufixo.length);
                            celula.text(sufixo);
                            segundaLinhaQuadroSugestoes.append(celula);
                        }
                        if (sugestoesDePalavrasLinha2.length) {
                            let celula = $('<td>').addClass('celula').addClass('celula_descrita').text('Continuar');
                            segundaLinhaQuadroSugestoes.append(celula);
                        }
                        $('.sugestoes').append(quadroSugestoes);
                    }
                }

                sugerirPalavras();

                let alterarAnotacao = (texto) => {
                    $('.anotacao__texto').text(texto);
                    $('.anotacao').scrollTop($('.anotacao').prop('scrollHeight'));
                }

                let anotar = (texto) => {
                    alterarAnotacao($('.anotacao__texto').text() + texto);
                };

                let trocarAreaPercorrida = function() {
                    if (permitirTrocaDeArea) {
                        permitirTrocaDeArea = false;
                        if (percorrendoQuadros) {
                            percorrendoQuadros = false;
                            percorrendoLinhas = true;
                            let linhas = elementoAtual.find('.linha');
                            if (linhas.length == 1) {
                                elementoAtual = $(linhas[0]);
                                percorrendoLinhas = false;
                                let celulas = elementoAtual.find('.celula');
                                if (celulas.length == 1) {
                                    percorrendoQuadros = true;
                                    anotar($(celulas[0].text()));
                                } else {
                                    percorrerAreas(celulas);
                                }
                            } else {
                                percorrerAreas(linhas);
                            }
                        } else if (percorrendoLinhas) {
                            percorrendoLinhas = false;
                            let celulas = elementoAtual.find('.celula');
                            percorrerAreas(celulas);
                        } else {
                            if (elementoAtual.hasClass('celula_descrita')) {
                                switch (elementoAtual.text()) {
                                    case 'Espaço':
                                        anotar(' ');
                                        sugerirPalavras();
                                    break;
                                    case 'Apagar letra':
                                        alterarAnotacao($('.anotacao__texto').text().substr(0, $('.anotacao__texto').text().length - 1));
                                        sugerirPalavras();
                                    break;
                                    case 'Apagar palavra':
                                        alterarAnotacao($('.anotacao__texto').text().replace(/[^|\s][^\s]*$/, ''));
                                        sugerirPalavras();
                                    break;
                                    case 'Acentuadas':
                                        acentuadas = true;
                                        $('.ponteiro').addClass('ponteiro_oculto');
                                        $('.quadro_letras').addClass('quadro_oculto');
                                        if (maiusculas) {
                                            $('.quadro_acentuadas.quadro_maiusculas').removeClass('quadro_oculto');
                                        } else {
                                            $('.quadro_acentuadas.quadro_minusculas').removeClass('quadro_oculto');
                                        }
                                        $('.celula_acentuadas-nao-acentuadas').text('Não acentuadas');
                                    break;
                                    case 'Não acentuadas':
                                        acentuadas = false;
                                        $('.ponteiro').addClass('ponteiro_oculto');
                                        $('.quadro_letras').addClass('quadro_oculto');
                                        if (maiusculas) {
                                            $('.quadro_nao-acentuadas.quadro_maiusculas').removeClass('quadro_oculto');
                                        } else {
                                            $('.quadro_nao-acentuadas.quadro_minusculas').removeClass('quadro_oculto');
                                        }
                                        $('.celula_acentuadas-nao-acentuadas').text('Acentuadas');
                                    break;
                                    case 'Maiúsculas':
                                        maiusculas = true;
                                        $('.ponteiro').addClass('ponteiro_oculto');
                                        $('.quadro_letras').addClass('quadro_oculto');
                                        if (acentuadas) {
                                            $('.quadro_maiusculas.quadro_acentuadas').removeClass('quadro_oculto');
                                        } else {
                                            $('.quadro_maiusculas.quadro_nao-acentuadas').removeClass('quadro_oculto');
                                        }
                                        $('.celula_maiusculas-minusculas').text('Minúsculas');
                                    break;
                                    case 'Minúsculas':
                                        maiusculas = false;
                                        $('.ponteiro').addClass('ponteiro_oculto');
                                        $('.quadro_letras').addClass('quadro_oculto');
                                        if (acentuadas) {
                                            $('.quadro_minusculas.quadro_acentuadas').removeClass('quadro_oculto');
                                        } else {
                                            $('.quadro_minusculas.quadro_nao-acentuadas').removeClass('quadro_oculto');
                                        }
                                        $('.celula_maiusculas-minusculas').text('Maiúsculas');
                                    break;
                                    case 'Ponto final':
                                        anotar('.');
                                        sugerirPalavras();
                                    break;
                                    case 'Vírgula':
                                        anotar(',');
                                        sugerirPalavras();
                                    break;
                                    case 'Falar e apagar tudo':
                                        SpeechSynthesisUtterance = window.webkitSpeechSynthesisUtterance ||
                                               window.mozSpeechSynthesisUtterance ||
                                               window.msSpeechSynthesisUtterance ||
                                               window.oSpeechSynthesisUtterance ||
                                               window.SpeechSynthesisUtterance;
                                        
                                        speech = new SpeechSynthesisUtterance()
                                        speech.text = $('.anotacao__texto').text();
                                        speech.rate = .5;
                                        speech.lang = "pt-BR";
                                        speechSynthesis.speak(speech); 
                                        $('.anotacao__texto').empty();
                                        sugerirPalavras();
                                    break;
                                    case 'Continuar':
                                    break;
                                    default:
                                    throw 'Símbolo desconhecido';
                                    break;
                                } 
                            } else {
                                anotar(elementoAtual.text());
                                sugerirPalavras();
                            }
                            percorrendoQuadros = true;
                            let quadros = $('.quadro:not(.quadro_oculto)');
                            percorrerAreas(quadros);
                        }
                    }
                } 

                $('.tela__aplicativo').bind('click', trocarAreaPercorrida);

                let quadros = $('.quadro:not(.quadro_oculto)');
                percorrerAreas(quadros);
                percorrendoQuadros = true;
            });
        });
        </script>
    </head>
    <body class="tela">
        <div class="tela__inicio">
            <div class="tela__conteudo-inicio">
                <h1>Head Typing</h1>
                <button class="tela__botao tela__botao_iniciar">Iniciar</button>            
                <button class="tela__botao tela__botao_continuar">Continuar</button>            
            </div>
        </div>
        <div class="tela__aplicativo">
            <div class="anotacao">
                <span class="anotacao__texto"></span>
            </div>
            <div class="ponteiro ponteiro_oculto"></div>
            <div class="sugestoes"></div>
            <table class="quadro quadro_letras quadro_acentuadas quadro_maiusculas quadro_oculto">
                <tr class="linha">
                    <td class="celula celula_pequena">Á</td>
                    <td class="celula celula_pequena">Ã</td>
                    <td class="celula celula_pequena">À</td>
                    <td class="celula celula_pequena">É</td>
                    <td class="celula celula_pequena">Ê</td>
                    <td class="celula celula_descrita celula_pequena">Continuar</td>
                </tr>
                <tr class="linha">
                    <td class="celula celula_pequena">Í</td>
                    <td class="celula celula_pequena">Ó</td>
                    <td class="celula celula_pequena">Õ</td>
                    <td class="celula celula_pequena">Ô</td>
                    <td class="celula celula_pequena">Ú</td>
                    <td class="celula celula_descrita celula_pequena">Continuar</td>
                </tr>
            </table>
            <table class="quadro quadro_letras quadro_acentuadas quadro_minusculas quadro_oculto">
                <tr class="linha">
                    <td class="celula celula_pequena">á</td>
                    <td class="celula celula_pequena">ã</td>
                    <td class="celula celula_pequena">à</td>
                    <td class="celula celula_pequena">é</td>
                    <td class="celula celula_pequena">ê</td>
                    <td class="celula celula_descrita celula_pequena">Continuar</td>
                </tr>
                <tr class="linha">
                    <td class="celula celula_pequena">í</td>
                    <td class="celula celula_pequena">ó</td>
                    <td class="celula celula_pequena">õ</td>
                    <td class="celula celula_pequena">ô</td>
                    <td class="celula celula_pequena">ú</td>
                    <td class="celula celula_descrita celula_pequena">Continuar</td>
                </tr>
            </table>
            <table class="quadro quadro_letras quadro_nao-acentuadas quadro_maiusculas quadro_oculto">
                <tr class="linha">
                    <td class="celula celula_pequena">A</td>
                    <td class="celula celula_pequena">E</td>
                    <td class="celula celula_pequena">O</td>
                    <td class="celula celula_pequena">S</td>
                    <td class="celula celula_pequena">R</td>
                    <td class="celula celula_descrita celula_pequena">Continuar</td>
                </tr>
                <tr class="linha">
                    <td class="celula celula_pequena">I</td>
                    <td class="celula celula_pequena">N</td>
                    <td class="celula celula_pequena">D</td>
                    <td class="celula celula_pequena">M</td>
                    <td class="celula celula_pequena">U</td>
                    <td class="celula celula_descrita celula_pequena">Continuar</td>
                </tr>
            </table>
            <table class="quadro quadro_letras quadro_nao-acentuadas quadro_maiusculas quadro_oculto">
                <tr class="linha">
                    <td class="celula">T</td>
                    <td class="celula">C</td>
                    <td class="celula">L</td>
                    <td class="celula">P</td>
                    <td class="celula celula_descrita">Continuar</td>
                </tr>
                <tr class="linha">
                    <td class="celula">V</td>
                    <td class="celula">G</td>
                    <td class="celula">H</td>
                    <td class="celula">Q</td>
                    <td class="celula celula_descrita">Continuar</td>
                </tr>
                <tr class="linha">
                    <td class="celula">B</td>
                    <td class="celula">F</td>
                    <td class="celula">Z</td>
                    <td class="celula">J</td>
                    <td class="celula celula_descrita">Continuar</td>
                </tr>
                <tr class="linha">
                    <td class="celula">X</td>
                    <td class="celula">K</td>
                    <td class="celula">W</td>
                    <td class="celula">Y</td>
                    <td class="celula celula_descrita">Continuar</td>
                </tr>
            </table>
            <table class="quadro quadro_letras quadro_nao-acentuadas quadro_minusculas">
                <tr class="linha">
                    <td class="celula celula_pequena">a</td>
                    <td class="celula celula_pequena">e</td>
                    <td class="celula celula_pequena">o</td>
                    <td class="celula celula_pequena">s</td>
                    <td class="celula celula_pequena">r</td>
                    <td class="celula celula_descrita celula_pequena">Continuar</td>
                </tr>
                <tr class="linha">
                    <td class="celula celula_pequena">i</td>
                    <td class="celula celula_pequena">n</td>
                    <td class="celula celula_pequena">d</td>
                    <td class="celula celula_pequena">m</td>
                    <td class="celula celula_pequena">u</td>
                    <td class="celula celula_descrita celula_pequena">Continuar</td>
                </tr>
            </table>
            <table class="quadro quadro_letras quadro_nao-acentuadas quadro_minusculas">
                <tr class="linha">
                    <td class="celula">t</td>
                    <td class="celula">c</td>
                    <td class="celula">l</td>
                    <td class="celula">p</td>
                    <td class="celula celula_descrita">Continuar</td>
                </tr>
                <tr class="linha">
                    <td class="celula">v</td>
                    <td class="celula">g</td>
                    <td class="celula">h</td>
                    <td class="celula">q</td>
                    <td class="celula celula_descrita">Continuar</td>
                </tr>
                <tr class="linha">
                    <td class="celula">b</td>
                    <td class="celula">f</td>
                    <td class="celula">z</td>
                    <td class="celula">j</td>
                    <td class="celula celula_descrita">Continuar</td>
                </tr>
                <tr class="linha">
                    <td class="celula">x</td>
                    <td class="celula">k</td>
                    <td class="celula">w</td>
                    <td class="celula">y</td>
                    <td class="celula celula_descrita">Continuar</td>
                </tr>
            </table>
            <table class="quadro">
                <tr class="linha">
                    <td class="celula celula_descrita">Espaço</td>
                    <td class="celula celula_descrita">Apagar letra</td>
                    <td class="celula celula_descrita">Apagar palavra</td>
                    <td class="celula celula_descrita">Falar e apagar tudo</td>
                    <td class="celula celula_descrita">Continuar</td>
                </tr>
                <tr class="linha">
                    <td class="celula celula_descrita celula_maiusculas-minusculas">Maiúsculas</td>
                    <td class="celula celula_descrita celula_acentuadas-nao-acentuadas">Acentuadas</td>
                    <td class="celula celula_descrita">Ponto final</td>
                    <td class="celula celula_descrita">Vírgula</td>
                    <td class="celula celula_descrita">Continuar</td>
                </tr>
            </table>
        </div>
    </body>
</html>
